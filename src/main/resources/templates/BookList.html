<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layout}">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- 밑의내용부터 content layout에 들어가니깐 이 내용이 charset=UTF-8라는 걸 적어야 한글이 안깨짐 -->
<div layout:fragment="content">

<link rel="stylesheet" type="text/css" href="css/BookList.css">

<script type="text/javascript" src="/js/ajaxUtil.js"></script>


</br></br></br></br>
</br></br></br></br>

<div class="BookList-container" th:each="i : ${#numbers.sequence(0,2)}" th:if="${#lists.size(lists)}>0">
	<div class="BookList-row" th:each="j : ${#numbers.sequence(0,2)}">
		
		<div class="BookList-img-box" th:each="dto: ${lists[3*i+j]}"> 
			<div>
			<a th:href="@{${articleUrl}} + '&seq_No=' + @{${dto.seq_No}}">
			<img alt="" th:src="@{${dto.image_Url}}"></a><br/>
			</div>
			
			<h5>[[${dto.title_Nm}]]</h5>
			<span>[[${dto.authr_Nm}]]</span><br/>
			<span>[[${dto.publisher_Nm}]]</span><br/>
			<span>[[${dto.prc_Value}]]원</span><br/>
			
			<div th:id="${dto.seq_No}">
            
			 <a th:onclick="|javascript:sendBag('${dto.seq_No}')|"><button style="background-color: #fff;" type="button">🤍</button></a>
			</div>
			<div th:id="'delete' + ${dto.seq_No}" style="display: none;">
			
			<a th:onclick="|javascript:sendDeleteBag('${dto.seq_No}')|"><button style="background-color: #fff;" type="button">❤️</button></a>
			</div> 
			
		</div>
	</div>
</div>

</br></br></br>

<div style="text-align: right; margin-right: 200px;">
	<button class="btn-555 float-r" th:onclick="|location.href='@{BookCreated.action}'|">등록하기</button>
</div>

<br/>
<div style="text-align: center;">
<a th:utext="${pageIndexList}"></a>
</div>

<script th:inline="javascript">

function sendBag(seq_No){
	
	if(seq_No==""){
		
		return;
	}
	
	if([[${session.user}]] == null){
		//session.user.userId 이건 비교할 수 없음 session.user는 비교가 됨
		//user가 없으면 애시당초 userId를 찾을 수가 없어서 에러가 남 그래서 딱 session.user까지만 비교를 해야 함
		
		alert("로그인 후 이용해주세요");
		
		window.location.href="/insertItem.action?seq_No=" + seq_No;
		
	}else if([[${session.user}]] != null){
		
		var params = "seq_No=" + seq_No;
		
		sendRequest("/insertItem.action",params,returnBag,"POST");
		//주의 : callback함수가 있으면 json형태로 값을 무조건 반환해주기 때문에 중간에 redirect같은 것이 안 됨
		
	}

}

function returnBag(){
	
	if(httpRequest.readyState==4){
		
		if(httpRequest.status==200){
			
			var text = httpRequest.responseText;
			var resultText = JSON.parse(text);
			var count = Object.keys(resultText.lists).length;

			for(var i=0;i<count;i++){

				showLike(resultText.lists[i].seq_No);
				
			}
		
		}
		
	}
	
}

function sendDeleteBag(seq_No){

	if(seq_No==""){
		
		return;
		
	}
	
	if([[${session.user}]] == null){
		
		alert("로그인이 만료되었습니다");
		
		window.location.href="/deleteItem.action?seq_No=" + seq_No;
		
	}else if([[${session.user}]] != null){
		
		var params = "seq_No=" + seq_No;
		
		sendRequest("/deleteItem.action",params,returnDeleteBag,"POST");
		
	}
	
}

function returnDeleteBag(){
	
	if(httpRequest.readyState==4){
		
		if(httpRequest.status==200){
			
			var text = httpRequest.responseText;
			var resultText = JSON.parse(text);
			
			hideLike(resultText.bagDTO.seq_No);

		}
		
	}
	
}

function sendAllItem(){
	
	if([[${session.user}]]!=null){
		
		var params = null;
		
		sendRequest("/selectItem.action",params,returnBag,"POST");
		
	}

}

window.onload = function(){
	
	sendAllItem();
	//navbar.html 하이드 여기서 실행이 안됨 why? window.onload가 2번 겹쳐서 그럼  그래서 hide();를 여기서 써줌
	hide();
	
}

function showLike(seq_No) {

	var beforeItem = document.getElementById(seq_No);
	//beforeItem이 null값이 나오면 다음 단계로 진행이 안됨 그래서 if으로 걸러야됨
	if(beforeItem!=null){

		var d_No = "delete" + seq_No;
		
		beforeItem.style.display = "none";
		
		var afterItem = document.getElementById(d_No);
		afterItem.style.display = "block";
		
	}

}

function hideLike(seq_No) {
	
	var d_No = "delete" + seq_No;

	var beforeItem = document.getElementById(seq_No);
	beforeItem.style.display = "block";

	var afterItem = document.getElementById(d_No);
	afterItem.style.display = "none";
	
}


</script>

</div>
</html>